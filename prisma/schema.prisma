generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id
  name          String
  email         String
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  sessions      Session[]
  accounts      Account[]

  @@unique([email])
  @@map("user")

  workspaces WorkspaceMember[]
  nodes Node[]
  fileRevisions FileRevision[]
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Workspace {
  id String @id @default(uuid())
  name String

  members WorkspaceMember[]
  nodes Node[]
}

model WorkspaceMember {
  id String @id @default(uuid())
  userId String
  workspaceId String
  role WorkspaceRole @default(MEMBER)

  workspace Workspace @relation(references: [id], fields: [workspaceId])
  user User @relation(references: [id], fields: [userId])

  @@unique([userId, workspaceId])
}

model Node {
  id        String   @id @default(uuid())
  workspaceId String
  parentId  String?
  type      NodeType     @default(FILE)
  name      String
  createdById String
  currentRevisionId String @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  fileRevisions FileRevision[] @relation("FileRevisions")
  closureAsAncestor NodeClosure[] @relation("Ancestor")
  closureAsDescendant NodeClosure[] @relation("Descendant")
  children Node[] @relation("NodeParent")

  currentRevision FileRevision @relation("CurrentRevision", references: [id], fields: [currentRevisionId])
  createdBy User @relation(references: [id], fields: [createdById])
  parent Node? @relation("NodeParent", references: [id], fields: [parentId])
  workspace Workspace @relation(references: [id], fields: [workspaceId])

  @@unique([workspaceId, parentId, name])
  @@index([workspaceId])
  @@index([parentId])
}

model Blob {
  id String @id @default(uuid())
  bucket String
  objectKey String
  sizeBytes BigInt
  contentType String?
  sha256 String?
  createdAt DateTime @default(now())

  fileRevision FileRevision[]
}

model FileRevision {
  id String @id @default(uuid())
  nodeId String
  blobId String
  rev Int
  createdById String
  createdAt DateTime @default(now())

  createdBy User @relation(fields: [createdById], references: [id])
  node Node @relation("FileRevisions", fields: [nodeId], references: [id])
  blob Blob @relation(fields: [blobId], references: [id])
  currentNode Node? @relation("CurrentRevision")

  @@unique([nodeId, rev])
}

model NodeClosure {
  ancestorId String
  descendantId String
  depth Int

  ancestor Node @relation("Ancestor", fields: [ancestorId], references: [id])
  descendant Node @relation("Descendant", fields: [descendantId], references: [id])

  @@id([ancestorId, descendantId])
  @@index([ancestorId])
  @@index([descendantId, depth])
}

enum NodeType {
  FILE
  FOLDER
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
}